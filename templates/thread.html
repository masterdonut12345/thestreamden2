<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ thread.title }} - The Stream Den</title>
    <style>
      :root {
        --ink: #1b2432;
        --muted: #4f5b73;
        --paper: #f2f4fb;
        --panel: #ffffff;
        --border: #c8d0dd;
        --accent: #2f4f9c;
        --accent-strong: #1f3d80;
      }
      * { box-sizing: border-box; }
      body {
        font-family: "Georgia", "Times New Roman", serif;
        color: var(--ink);
        background: var(--paper);
        padding: 26px 16px 40px;
        margin: 0;
      }
      a { color: var(--accent); }
      a:visited { color: var(--accent-strong); }

      .shell {
        max-width: 1080px;
        margin: 0 auto;
        background: var(--panel);
        border: 1px solid var(--border);
        box-shadow: 0 12px 30px rgba(26, 44, 92, 0.18);
      }
      .header {
        padding: 16px 18px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .header h1 { margin: 0; font-size: 22px; letter-spacing: -0.01em; }
      .crumbs { padding: 10px 18px; border-bottom: 1px solid var(--border); background: #f7f9ff; }
      .crumbs a { text-decoration: none; font-weight: 600; }
      .sep { padding: 0 6px; color: var(--muted); }

      .player {
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, #f7f9ff, #eef3ff);
      }
      .player-box {
        border: 1px solid var(--border);
        background: #fff;
        padding: 12px;
        box-shadow: inset 0 0 0 1px #ffffffcc;
      }
      .player a { font-weight: 700; }
      .player iframe {
        width: 100%;
        min-height: 320px;
        border: 1px solid var(--border);
      }

      .content { padding: 16px 18px 24px 18px; }
      .panel { border: 1px solid var(--border); background: #fff; padding: 12px; }
      .panel + .panel { margin-top: 14px; }

      .post-list { list-style: none; padding: 0; margin: 0; }
      .post-item { border: 1px solid var(--border); padding: 10px 12px; background: #fbfcff; margin-bottom: 10px; }
      .post-meta { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
      .post-body { font-size: 14px; white-space: pre-wrap; }
      .replies { margin-left: 16px; margin-top: 10px; padding-left: 10px; border-left: 2px solid var(--border); }

      .reply-actions { margin-top: 8px; }
      .reply-btn {
        font-size: 12px;
        border: 1px solid var(--border);
        background: #f0f4fb;
        color: var(--accent-strong);
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 3px;
      }

      .form-box { margin-top: 8px; }
      textarea {
        width: 100%;
        min-height: 100px;
        border: 1px solid var(--border);
        border-radius: 3px;
        padding: 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
      }
      .submit-btn {
        margin-top: 8px;
        padding: 8px 12px;
        border: 1px solid var(--border);
        background: #f0f4fb;
        color: var(--accent-strong);
        cursor: pointer;
        border-radius: 3px;
      }

      @media (max-width: 760px) {
        body { padding: 18px 12px 28px; }
        .header { flex-direction: column; align-items: flex-start; }
        .crumbs { overflow-x: auto; }
        .player iframe { min-height: 220px; }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="header">
        <h1>{{ thread.title }}</h1>
        <a class="nav-btn" style="text-decoration:none; padding:8px 10px; border:1px solid var(--border); background:#f0f4fb; color:var(--accent-strong); border-radius:3px;" href="/forum{% if thread.category_id %}/{{ build_category_path(cat_lookup.get(thread.category_id), cat_lookup) }}{% endif %}">← Back to category</a>
      </div>
      <div class="crumbs">
        <a href="/forum">Forum</a><span class="sep">»</span>
        {% if thread.category_id %}
          <a href="/forum/{{ build_category_path(cat_lookup.get(thread.category_id), cat_lookup) }}">Category</a><span class="sep">»</span>
        {% endif %}
        <span>{{ thread.title }}</span>
        {% if thread.tag %}
          <span class="sep">»</span><span style="font-weight:700; color:var(--accent-strong);">#{{ thread.tag }}</span>
        {% endif %}
      </div>

      <div class="player">
        <div class="player-box">
          <div style="font-weight:700; margin-bottom:6px;">Stream</div>
          {% if embed_info.type == "iframe" %}
            <iframe src="{{ embed_info.src }}" title="{{ embed_info.title or 'Stream' }}" allowfullscreen></iframe>
            <div style="margin-top:6px;"><a href="{{ thread.stream_link }}" target="_blank" rel="noopener">Open stream link</a></div>
          {% elif embed_info.type == "x" %}
            <div class="embed-html">{{ embed_info.html | safe }}</div>
            <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            <div style="margin-top:6px;"><a href="{{ thread.stream_link }}" target="_blank" rel="noopener">Open stream link</a></div>
          {% elif embed_info.type == "html" %}
            <div class="embed-html">{{ embed_info.html | safe }}</div>
            <div style="margin-top:6px;"><a href="{{ thread.stream_link }}" target="_blank" rel="noopener">Open stream link</a></div>
          {% elif embed_info.type == "video" %}
            <video src="{{ embed_info.src }}" controls style="width:100%; border:1px solid var(--border);"></video>
            <div style="margin-top:6px;"><a href="{{ thread.stream_link }}" target="_blank" rel="noopener">Open stream link</a></div>
          {% elif embed_info.type == "m3u8" %}
            <video controls style="width:100%; border:1px solid var(--border);">
              <source src="{{ embed_info.src }}" type="application/x-mpegURL">
            </video>
            <div style="margin-top:6px;"><a href="{{ thread.stream_link }}" target="_blank" rel="noopener">Open stream link</a></div>
          {% else %}
            <div><a href="{{ thread.stream_link }}" target="_blank" rel="noopener">{{ thread.stream_link }}</a></div>
          {% endif %}
        </div>
      </div>

      <div class="content">
        <div class="panel">
          <h3 style="margin-top:0;">New post</h3>
          {% if current_user %}
            <form action="/thread/{{ thread.id }}/reply" method="POST">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <input type="hidden" name="parent_id" value="">
              <textarea name="body" maxlength="2000" required placeholder="Share your thoughts..."></textarea>
              <button class="submit-btn" type="submit">Post reply</button>
            </form>
          {% else %}
            <div class="post-item">Login to post. <a href="/login?next=/thread/{{ thread.id }}">Login</a> or <a href="/signup?next=/thread/{{ thread.id }}">Sign up</a></div>
          {% endif %}
        </div>

        <div class="panel">
          <h3 style="margin-top:0;">Posts</h3>
          {% if posts_tree|length == 0 %}
            <div class="post-item">No posts yet.</div>
          {% else %}
            <ul class="post-list">
              {% for p in posts_tree %}
                {% include "thread_post.html" with context %}
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>
    </div>
  </body>
</html>
